{% extends "base.html" %}

{% block title %}Timeline - {{ watchlist.name }} - Bridge Ping{% endblock %}

{% block content %}
<style>
    .timeline-event {
        border-left: 4px solid #007bff;
        padding-left: 20px;
        margin-bottom: 20px;
        position: relative;
    }
    .timeline-event::before {
        content: '';
        position: absolute;
        left: -8px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #007bff;
        border: 2px solid white;
    }
    .timeline-event.past {
        border-left-color: #6c757d;
        opacity: 0.7;
    }
    .timeline-event.past::before {
        background: #6c757d;
    }
    .timeline-event.current {
        border-left-color: #28a745;
        background-color: #f0f8f0;
    }
    .timeline-event.current::before {
        background: #28a745;
        box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.2);
    }
    .event-time {
        font-size: 0.9em;
        color: #6c757d;
    }
    .timeline-section {
        margin-bottom: 40px;
    }
</style>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Bridge Opening Timeline</h4>
                <div>
                    <a href="/watchlist/{{ watchlist.name }}" class="btn btn-sm btn-light">
                        <i class="bi bi-list-check"></i> Back to Watchlist
                    </a>
                    <a href="webcal://{{ request.headers.host }}/calendar/watchlist/{{ watchlist.name }}.ics" class="btn btn-sm btn-success">
                        <i class="bi bi-calendar-plus"></i> Subscribe to Calendar
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Filter Controls -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="hours-filter" class="form-label">Time Range</label>
                        <select class="form-select" id="hours-filter" onchange="updateTimeRange()">
                            <option value="24" {% if hours == 24 %}selected{% endif %}>Next 24 hours</option>
                            <option value="48" {% if hours == 48 %}selected{% endif %}>Next 48 hours</option>
                            <option value="72" {% if hours == 72 %}selected{% endif %}>Next 3 days</option>
                            <option value="168" {% if hours == 168 %}selected{% endif %}>Next 7 days</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Timezone</label>
                        <div class="form-control-plaintext">{{ user_tz }}</div>
                    </div>
                </div>

                {% if openings %}
                    {% set current_date = None %}
                    {% set now = openings[0].start_datetime.now(openings[0].start_datetime.tzinfo) %}
                    
                    {% for opening in openings %}
                        {% set opening_date = opening.start_datetime.strftime('%A, %B %d, %Y') %}
                        
                        <!-- Add date header if it's a new day -->
                        {% if opening_date != current_date %}
                            {% set current_date = opening_date %}
                            <div class="timeline-section">
                                <h5 class="text-primary mb-3">{{ opening_date }}</h5>
                        {% endif %}
                        
                        {% set is_past = opening.end_datetime < now %}
                        {% set is_current = opening.start_datetime <= now and opening.end_datetime >= now %}
                        
                        <div class="timeline-event {% if is_past %}past{% elif is_current %}current{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        {{ opening.bridge_name }}
                                        {% if is_current %}
                                        <span class="badge bg-success ms-2">OPEN NOW</span>
                                        {% endif %}
                                    </h6>
                                    {% if opening.city or opening.neighborhood %}
                                    <small class="text-muted">
                                        {% if opening.neighborhood %}{{ opening.neighborhood }}{% if opening.city %}, {% endif %}{% endif %}
                                        {% if opening.city %}{{ opening.city }}{% endif %}
                                    </small>
                                    {% endif %}
                                </div>
                                <span class="badge bg-secondary">{{ opening.duration_minutes }} min</span>
                            </div>
                            <div class="event-time mt-2">
                                <i class="bi bi-clock"></i>
                                {{ opening.start_datetime.strftime('%H:%M') }} - {{ opening.end_datetime.strftime('%H:%M') }}
                            </div>
                            {% if opening.street_name or opening.water_name %}
                            <small class="text-muted">
                                {% if opening.street_name %}{{ opening.street_name }}{% endif %}
                                {% if opening.water_name %}over {{ opening.water_name }}{% endif %}
                            </small>
                            {% endif %}
                        </div>
                        
                        <!-- Close section div if this is the last event of the day or the last event overall -->
                        {% if loop.last or (not loop.last and openings[loop.index].start_datetime.strftime('%A, %B %d, %Y') != opening_date) %}
                            </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        <h5 class="alert-heading">No Upcoming Bridge Openings</h5>
                        <p class="mb-0">There are no scheduled bridge openings for your watched bridges in the next {{ hours }} hours.</p>
                        <hr>
                        <p class="mb-0">
                            <a href="/watchlist/{{ watchlist.name }}" class="alert-link">Add more bridges to your watchlist</a> to see their opening times here.
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function updateTimeRange() {
    const hours = document.getElementById('hours-filter').value;
    window.location.href = `/timeline/{{ watchlist.name }}?hours=${hours}`;
}
</script>
{% endblock %}