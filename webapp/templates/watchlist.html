{% extends "base.html" %}

{% block title %}{{ watchlist.name }} - Bridge Ping{% endblock %}

{% block extra_head %}
<style>
    #map { height: 400px; margin-bottom: 20px; border-radius: 8px; }
    .bridge-marker { cursor: pointer; }
    .watchlist-url {
        background-color: #f8f9fa;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        font-family: monospace;
        word-break: break-all;
    }
    .share-buttons .btn {
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- Watchlist Info Card -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Your Watchlist URL</h5>
                <p class="text-muted">Save this URL to access your watchlist later. Anyone with this URL can view and edit this watchlist.</p>
                <div class="watchlist-url mb-3" id="watchlist-url">{{ request.url }}</div>
                <div class="share-buttons">
                    <button class="btn btn-primary" onclick="copyToClipboard(event)">
                        <i class="bi bi-clipboard"></i> Copy URL
                    </button>
                    <a href="/timeline/{{ watchlist.name }}" class="btn btn-info">
                        <i class="bi bi-calendar-week"></i> View Timeline
                    </a>
                    <a href="webcal://{{ request.headers.host }}/calendar/watchlist/{{ watchlist.name }}.ics" class="btn btn-success">
                        <i class="bi bi-calendar-plus"></i> Subscribe to Calendar
                    </a>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Watchlist: <span class="watchlist-name">{{ watchlist.name }}</span></h4>
                <span class="badge bg-light text-dark">{{ bridges|length }} bridges</span>
            </div>
            <div class="card-body">
                <!-- Location Search -->
                <div class="mb-4">
                    <h5>Find Bridges Near Location</h5>
                    <div class="row g-3">
                        <div class="col-auto flex-grow-1">
                            <div class="input-group">
                                <input type="text" class="form-control" id="location-search" 
                                       placeholder="Start typing address (e.g., Bickerswerf 19)" 
                                       autocomplete="off">
                                <button class="btn btn-outline-secondary" type="button" id="location-search-btn">
                                    <i class="bi bi-search"></i> Search Location
                                </button>
                            </div>
                            <div id="location-results" class="list-group position-absolute w-100 mt-1" 
                                 style="max-height: 200px; overflow-y: auto; z-index: 1001; display: none;">
                            </div>
                        </div>
                    </div>
                    <small class="text-muted">Search for an address to center the map and find nearby bridges</small>
                </div>

                <!-- Add Bridge Form -->
                <div class="mb-4">
                    <h5>Add a Bridge</h5>
                    <form method="POST" action="/watchlist/{{ watchlist.name }}/add" class="row g-3">
                        <div class="col-auto flex-grow-1">
                            <input type="text" class="form-control" id="bridge-search" name="bridge_name" 
                                   placeholder="Search and add a bridge by name" required maxlength="100"
                                   autocomplete="off">
                            <div id="search-results" class="list-group position-absolute w-100 mt-1" 
                                 style="max-height: 300px; overflow-y: auto; z-index: 1000; display: none;">
                            </div>
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-success">Add Bridge</button>
                        </div>
                    </form>
                </div>

                <!-- Watchlist Table -->
                {% if bridges %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Bridge Name</th>
                                <th>Added On</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bridge in bridges %}
                            <tr>
                                <td>
                                    {% if bridge.bridge_id %}
                                    <a href="/bridge/{{ bridge.bridge_id }}" class="text-decoration-none">
                                        {{ bridge.bridge_name }}
                                    </a>
                                    {% else %}
                                    {{ bridge.bridge_name }}
                                    {% endif %}
                                </td>
                                <td>{{ bridge.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <form method="POST" action="/watchlist/{{ watchlist.name }}/remove/{{ bridge.id }}" 
                                          class="d-inline" 
                                          onsubmit="return confirm('Remove {{ bridge.bridge_name }} from watchlist?');">
                                        <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <p class="mb-0">You haven't added any bridges to your watchlist yet.</p>
                </div>
                {% endif %}
                
                <!-- Map Section -->
                <div class="mt-4">
                    <h5>Bridge Locations</h5>
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
// Initialize map
var map = L.map('map').setView([52.3702, 4.8952], 11); // Amsterdam coordinates

// Add OpenStreetMap tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// Bridge location data from server
var bridgeMapData = {{ bridge_map_data | tojson }};
var allBridgeCoords = {{ all_bridge_coords | tojson }};

// Add markers for watched bridges
var watchedMarkers = [];
Object.entries(bridgeMapData).forEach(function([bridgeId, data]) {
    var marker = L.marker([data.lat, data.lon])
        .bindPopup('<b>' + data.name + '</b>')
        .addTo(map);
    watchedMarkers.push(marker);
});

// Fit map to show all watched bridges if any exist
if (watchedMarkers.length > 0) {
    var group = new L.featureGroup(watchedMarkers);
    map.fitBounds(group.getBounds().pad(0.1));
}

// Keep track of search markers
var searchMarkers = L.layerGroup().addTo(map);

// Bridge autocomplete functionality
var bridgeSearch = document.getElementById('bridge-search');
var searchResults = document.getElementById('search-results');
var bridgeSuggestions = {{ bridge_suggestions | tojson }};
var bridgeIdMap = {{ bridge_id_map | tojson }};

// Hidden input for bridge_id
var hiddenBridgeId = document.createElement('input');
hiddenBridgeId.type = 'hidden';
hiddenBridgeId.name = 'bridge_id';
bridgeSearch.parentNode.appendChild(hiddenBridgeId);

// Show all suggestions when focused
bridgeSearch.addEventListener('focus', function() {
    if (this.value.trim() === '') {
        showAllSuggestions();
    }
});

function showAllSuggestions() {
    searchResults.innerHTML = '';
    searchResults.style.display = 'block';
    
    // Show first 20 suggestions
    bridgeSuggestions.slice(0, 20).forEach(function(suggestion) {
        var item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action';
        item.innerHTML = suggestion;
        
        item.addEventListener('click', function(e) {
            e.preventDefault();
            selectBridge(suggestion);
        });
        
        searchResults.appendChild(item);
    });
}

function selectBridge(suggestion) {
    bridgeSearch.value = suggestion;
    hiddenBridgeId.value = bridgeIdMap[suggestion] || '';
    searchResults.style.display = 'none';
    
    // Show location on map if we have coordinates
    var bridgeId = bridgeIdMap[suggestion];
    if (bridgeId && allBridgeCoords[bridgeId]) {
        var coords = allBridgeCoords[bridgeId];
        map.setView([coords.lat, coords.lon], 15);
        
        // Highlight the bridge on the map
        searchMarkers.clearLayers();
        L.marker([coords.lat, coords.lon])
            .bindPopup('<b>' + suggestion + '</b>')
            .addTo(searchMarkers)
            .openPopup();
    }
}

// Filter suggestions on input
bridgeSearch.addEventListener('input', function() {
    var searchTerm = this.value.toLowerCase();
    searchResults.innerHTML = '';
    
    if (searchTerm.length === 0) {
        showAllSuggestions();
        return;
    }
    
    var filtered = bridgeSuggestions.filter(function(suggestion) {
        return suggestion.toLowerCase().includes(searchTerm);
    });
    
    if (filtered.length === 0) {
        searchResults.style.display = 'none';
        hiddenBridgeId.value = '';
        return;
    }
    
    searchResults.style.display = 'block';
    
    filtered.slice(0, 20).forEach(function(suggestion) {
        var item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action';
        
        // Highlight matching text
        var regex = new RegExp('(' + searchTerm + ')', 'gi');
        item.innerHTML = suggestion.replace(regex, '<strong>$1</strong>');
        
        item.addEventListener('click', function(e) {
            e.preventDefault();
            selectBridge(suggestion);
        });
        
        searchResults.appendChild(item);
    });
});

// Hide results when clicking outside
document.addEventListener('click', function(e) {
    if (!bridgeSearch.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = 'none';
    }
});

// Location search functionality
var locationSearch = document.getElementById('location-search');
var locationResults = document.getElementById('location-results');
var locationSearchBtn = document.getElementById('location-search-btn');

locationSearch.addEventListener('input', debounce(searchLocation, 300));
locationSearchBtn.addEventListener('click', function() {
    searchLocation();
});

locationSearch.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchLocation();
    }
});

function searchLocation() {
    var query = locationSearch.value.trim();
    if (query.length < 3) return;
    
    // Add Netherlands to query for better results
    var searchQuery = query + ', Netherlands';
    
    fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(searchQuery) + '&limit=5&countrycodes=nl')
        .then(response => response.json())
        .then(data => {
            locationResults.innerHTML = '';
            if (data.length === 0) {
                locationResults.style.display = 'none';
                return;
            }
            
            locationResults.style.display = 'block';
            data.forEach(function(result) {
                var item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = result.display_name;
                
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    selectLocation(result);
                });
                
                locationResults.appendChild(item);
            });
        });
}

function selectLocation(location) {
    locationSearch.value = location.display_name;
    locationResults.style.display = 'none';
    
    // Center map on location
    var lat = parseFloat(location.lat);
    var lon = parseFloat(location.lon);
    map.setView([lat, lon], 14);
    
    // Add a temporary marker
    searchMarkers.clearLayers();
    L.marker([lat, lon])
        .bindPopup('<b>Search Location</b><br>' + location.display_name)
        .addTo(searchMarkers)
        .openPopup();
}

// Hide location results when clicking outside
document.addEventListener('click', function(e) {
    if (!locationSearch.contains(e.target) && !locationResults.contains(e.target)) {
        locationResults.style.display = 'none';
    }
});

// Debounce function to limit API calls
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Copy to clipboard function
function copyToClipboard(event) {
    var urlText = document.getElementById('watchlist-url').textContent;
    navigator.clipboard.writeText(urlText).then(function() {
        // Show success message
        var btn = event.target.closest('button');
        var originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Copied!';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        
        setTimeout(function() {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
        }, 2000);
    }).catch(function(err) {
        console.error('Failed to copy: ', err);
        // Fallback for older browsers
        var textArea = document.createElement("textarea");
        textArea.value = urlText;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            // Show success message
            var btn = event.target.closest('button');
            var originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Copied!';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            
            setTimeout(function() {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 2000);
        } catch (err) {
            alert('Failed to copy URL. Please copy manually: ' + urlText);
        }
        document.body.removeChild(textArea);
    });
}
</script>
{% endblock %}